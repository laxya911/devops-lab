// ============================================================================
// Jenkins Pipeline for Phase 1: Static Website
// ============================================================================
// This Jenkinsfile defines the CI/CD pipeline for building, testing,
// and deploying the static website to Kubernetes

pipeline {
    // Run on any available Jenkins agent
    agent any

    environment {
        NEXUS_REGISTRY = '192.168.0.213:5000'  // Nexus Docker registry
        NEXUS_REPO     = 'docker-hosted'          // Repository name in Nexus
        
        // Image configuration
        IMAGE_NAME     = 'static-site'
        IMAGE_TAG      = "${env.BUILD_NUMBER}"         // Use Jenkins build number as tag
        FULL_IMAGE_NAME = "${env.NEXUS_REGISTRY}/${env.IMAGE_NAME}:${env.IMAGE_TAG}"
        
        KUBECONFIG     = '/home/ansible/.kube/config'
        K8S_NAMESPACE  = 'default'                // Kubernetes namespace
        
        // Docker configuration
        DOCKER_BUILDKIT = '1'  // Enable BuildKit for faster builds
    }

    stages {
        // ====================================================================
        // Stage 1: Build Docker Image
        // ====================================================================
        stage('Build Image') {
            steps {
                echo 'ðŸ”¨ Building Docker image...'
                script {
                    dir("proxmox/phase1-static-site") {
                        sh """
                            docker build -t ${env.FULL_IMAGE_NAME} .
                            docker tag ${env.FULL_IMAGE_NAME} ${env.NEXUS_REGISTRY}/${env.IMAGE_NAME}:latest
                        """
                    }
                }
            }
        }

        // ====================================================================
        // Stage 2: Test Image
        // ====================================================================
        stage('Test Image') {
            steps {
                echo 'ðŸ§ª Testing Docker image...'
                script {
                    sh """
                        # Remove any existing test-container
                        docker rm -f test-container || true
                        
                        # Start container in background
                        docker run -d --name test-container ${env.FULL_IMAGE_NAME}
                        
                        # Wait for container to start
                        sleep 5
                        
                        # Check if container is running
                        docker ps | grep test-container
                        
                        # Check nginx configuration is valid
                        docker exec test-container nginx -t
                        
                        # Test HTTP response from inside the container
                        docker exec test-container curl -f http://localhost:80 || exit 1
                        
                        # Cleanup test container
                        docker stop test-container
                        docker rm test-container
                    """
                }
            }
        }

        // ====================================================================
        // Stage 3: Push to Nexus
        // ====================================================================
        stage('Push to Nexus') {
            steps {
                echo 'ðŸ“¤ Pushing image to Nexus registry...'
                script {
                    // Use the Nexus credentials stored in Jenkins
                    withCredentials([usernamePassword(
                        credentialsId: 'nexus-credentials',
                        usernameVariable: 'NEXUS_USER',
                        passwordVariable: 'NEXUS_PASS'
                    )]) {
                        sh """
                            # Login to Nexus Docker registry
                            echo ${env.NEXUS_PASS} | docker login ${env.NEXUS_REGISTRY} -u ${env.NEXUS_USER} --password-stdin
                            
                            # Push versioned image
                            docker push ${env.FULL_IMAGE_NAME}
                            
                            # Push latest tag
                            docker push ${env.NEXUS_REGISTRY}/${env.IMAGE_NAME}:latest
                            
                            # Logout from registry
                            docker logout ${env.NEXUS_REGISTRY}
                        """
                    }
                }
            }
        }

        // ====================================================================
        // Stage 4: Deploy to Kubernetes
        // ====================================================================
        stage('Deploy to K8s') {
            steps {
                echo 'ðŸš€ Deploying to Kubernetes...'
                script {
                    // Update deployment with new image
                    dir("proxmox/phase1-static-site/k8s") {
                        sh """
                            # Apply deployment and service YAMLs
                            kubectl apply -f deployment.yaml --namespace=${env.K8S_NAMESPACE}
                            kubectl apply -f service.yaml --namespace=${env.K8S_NAMESPACE}
                            
                            # Set the new image in deployment
                            kubectl set image deployment/static-site nginx=${env.FULL_IMAGE_NAME} --namespace=${env.K8S_NAMESPACE}
                            
                            # Wait for rollout to complete
                            kubectl rollout status deployment/static-site --namespace=${env.K8S_NAMESPACE} --timeout=5m
                        """
                    }
                }
            }
        }

        // ====================================================================
        // Stage 5: Verify Deployment
        // ====================================================================
        stage('Verify') {
            steps {
                echo 'âœ”ï¸ Verifying deployment...'
                script {
                    sh """
                        # Get deployment status
                        kubectl get deployment static-site --namespace=${env.K8S_NAMESPACE}
                        
                        # Get pods
                        kubectl get pods -l app=static-site --namespace=${env.K8S_NAMESPACE}
                        
                        # Get service
                        kubectl get svc static-site --namespace=${env.K8S_NAMESPACE}
                    """
                }
            }
        }
    }

    // ========================================================================
    // Post-Build Actions
    // ========================================================================
    post {
        always {
            echo 'ðŸ§¹ Cleaning up...'
            script {
                // Remove local Docker images to save space
                sh """
                    docker rmi -f ${env.FULL_IMAGE_NAME} || true
                    docker rmi -f ${env.NEXUS_REGISTRY}/${env.IMAGE_NAME}:latest || true
                """
            }
        }
        
        success {
            echo 'âœ… Pipeline completed successfully!'
            echo "Access application via NodePort: kubectl get svc static-site"
        }
        
        failure {
            echo 'âŒ Pipeline failed!'
            echo 'Check console output for error details'
        }
    }
}

// ============================================================================
// Pipeline Setup Instructions
// ============================================================================
/*
1. Create New Pipeline Job in Jenkins:
   - Go to Jenkins Dashboard -> "New Item" -> Enter name -> Select "Pipeline"
2. Configure Pipeline:
   - Definition: "Pipeline script from SCM" -> SCM: Git -> Repos: <your-git-repo>
   - Script Path: proxmox/phase1-static-site/Jenkinsfile
3. Required Jenkins Plugins: Docker Pipeline, Kubernetes CLI, Git
4. Required Credentials: Create 'nexus-credentials' as Username/Password (admin/nexus)
*/