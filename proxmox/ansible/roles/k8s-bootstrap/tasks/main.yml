---
# Role tasks: apply RBAC and generate scoped kubeconfig for the jenkins-deployer SA.
# This role is intended to be invoked from a play targeting the Kubernetes master.

- name: Copy RBAC manifest to master
  copy:
    src: "{{ playbook_dir }}/../k8s/jenkins-deployer-rbac.yaml"
    dest: /tmp/jenkins-deployer-rbac.yaml

- name: Apply RBAC manifest using server kubeconfig
  command: kubectl apply -f /tmp/jenkins-deployer-rbac.yaml --kubeconfig=/etc/rancher/k3s/k3s.yaml

- name: Create a token for the jenkins-deployer ServiceAccount
  command: kubectl create token jenkins-deployer -n default --kubeconfig=/etc/rancher/k3s/k3s.yaml
  register: sa_token

- name: Read server kubeconfig (for cluster CA and endpoint)
  slurp:
    src: /etc/rancher/k3s/k3s.yaml
  register: server_kubeconfig

- name: Render scoped kubeconfig for Jenkins
  set_fact:
    jenkins_kubeconfig: |
      apiVersion: v1
      kind: Config
      clusters:
      - cluster:
          certificate-authority-data: "{{ (server_kubeconfig.content | b64decode | from_yaml).clusters[0].cluster.'certificate-authority-data' }}"
          server: "{{ (server_kubeconfig.content | b64decode | from_yaml).clusters[0].cluster.server }}"
        name: k3s-cluster
      contexts:
      - context:
          cluster: k3s-cluster
          user: jenkins-deployer
        name: jenkins-deployer@k3s
      current-context: jenkins-deployer@k3s
      users:
      - name: jenkins-deployer
        user:
          token: "{{ sa_token.stdout | default(sa_token.stdout_lines | join('\n')) }}"

- name: Write scoped kubeconfig to temporary file on master
  copy:
    content: "{{ jenkins_kubeconfig }}"
    dest: /tmp/jenkins-deployer.kubeconfig
    mode: '0600'

- name: Copy scoped kubeconfig to cicd host (using Ansible control connection)
  copy:
    src: /tmp/jenkins-deployer.kubeconfig
    dest: "/home/{{ ansible_user | default('ubuntu') }}/jenkins-deployer.kubeconfig"
    owner: "{{ ansible_user | default('ubuntu') }}"
    group: "{{ ansible_user | default('ubuntu') }}"
    mode: '0600'
  delegate_to: "{{ groups['cicd'][0] }}"

- name: (Optional) Install Jenkins CLI on cicd host if admin creds provided
  when: jenkins_admin_user is defined and jenkins_admin_token is defined and jenkins_url is defined
  block:
    - name: Download jenkins-cli.jar to cicd host
      get_url:
        url: "{{ jenkins_url }}/jnlpJars/jenkins-cli.jar"
        dest: /tmp/jenkins-cli.jar
      delegate_to: "{{ groups['cicd'][0] }}"

    - name: Create credentials XML on cicd host
      copy:
        dest: /tmp/jenkins-kube-cred.xml
        content: |
          <com.cloudbees.plugins.credentials.impl.BaseCredentialModule>
            <id>kubeconfig-jenkins-deployer</id>
          </com.cloudbees.plugins.credentials.impl.BaseCredentialModule>
      delegate_to: "{{ groups['cicd'][0] }}"

    - name: (Optional) Note: Jenkins CLI credential creation requires a credential XML tailored to installed plugins. Manual step may be needed.
      debug:
        msg: "Jenkins CLI credential creation attempted; if you need auto-creation provide a credentials XML template and ensure Jenkins CLI access."
      delegate_to: "{{ groups['cicd'][0] }}"
