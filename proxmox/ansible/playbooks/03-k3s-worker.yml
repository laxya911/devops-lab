################################################################################
# ANSIBLE PLAYBOOK 03: KUBERNETES WORKER NODE SETUP (K3S AGENT)
################################################################################

---
- name: Setup Kubernetes Worker Nodes (K3s Agent)
  hosts: kubernetes_workers
  become: true
  gather_facts: true

  vars:
    provision_user: ansible
    k3s_version: "v1.28.3+k3s1"

    # Dynamically pick the first master
    k3s_master: "{{ groups['kubernetes_master'][0] }}"
    k3s_master_ip: "{{ hostvars[k3s_master].ansible_host }}"

  tasks:
    # ============================================================================
    # FIREWALL PREPARATION
    # ============================================================================

    - name: Allow required K3s worker ports
      ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
      loop:
        - { port: '10250', proto: 'tcp' }
        - { port: '10255', proto: 'tcp' }
        - { port: '8472', proto: 'udp' }
        - { port: '30000:32767', proto: 'tcp' }

    - name: Allow loopback traffic
      ufw:
        rule: allow
        interface: lo
        direction: in

    # ============================================================================
    # FETCH K3S WORKER TOKEN FROM MASTER
    # ============================================================================

    - name: Get worker join token from master
      command: cat /var/lib/rancher/k3s/server/node-token
      delegate_to: "{{ k3s_master }}"
      run_once: true
      register: worker_token

    - set_fact:
        k3s_token: "{{ worker_token.stdout | trim }}"

    # ============================================================================
    # PRE-CHECK
    # ============================================================================

    - name: Check if K3s agent already installed
      stat:
        path: /usr/local/bin/k3s
      register: k3s_agent_binary

    # ============================================================================
    # K3S AGENT CONFIGURATION
    # ============================================================================

    - name: Create K3s configuration directory
      file:
        path: /etc/rancher/k3s
        state: directory
        mode: '0755'

    - name: Create K3s agent config
      copy:
        dest: /etc/rancher/k3s/config.yaml
        owner: root
        group: root
        mode: '0600'
        content: |
          server: "https://{{ k3s_master_ip }}:6443"
          token: "{{ k3s_token }}"
          node-ip: "{{ ansible_host }}"
          flannel-iface: "{{ ansible_default_ipv4.interface }}"
          kubelet-arg:
            - "max-pods=110"

    # ============================================================================
    # INSTALL K3S AGENT
    # ============================================================================

    - name: Download K3s install script
      get_url:
        url: https://get.k3s.io
        dest: /tmp/install_k3s.sh
        mode: '0755'
      when: not k3s_agent_binary.stat.exists

    - name: Install K3s agent
      shell: sh /tmp/install_k3s.sh
      when: not k3s_agent_binary.stat.exists
      environment:
        INSTALL_K3S_VERSION: "{{ k3s_version }}"
        INSTALL_K3S_EXEC: "agent"

    - name: Enable and start K3s agent
      systemd:
        name: k3s-agent
        state: restarted
        enabled: yes
        daemon_reload: yes

    # ============================================================================
    # WAIT FOR NODE TO JOIN CLUSTER
    # ============================================================================

    - name: Wait for worker to appear in cluster
      shell: kubectl get nodes | grep {{ inventory_hostname }}
      delegate_to: "{{ k3s_master }}"
      environment:
        KUBECONFIG: "/home/{{ provision_user }}/.kube/config"
      register: join_status
      until: join_status.rc == 0
      retries: 20
      delay: 10

    # ============================================================================
    # LABEL WORKER NODE
    # ============================================================================

    - name: Label worker node
      shell: |
        kubectl label node {{ inventory_hostname }} \
        node-role.kubernetes.io/worker=true \
        workload-type=general --overwrite
      delegate_to: "{{ k3s_master }}"
      environment:
        KUBECONFIG: "/home/{{ provision_user }}/.kube/config"

    # ============================================================================
    # KUBECONFIG DISTRIBUTION
    # ============================================================================

    - name: Ensure k3s directory exists on worker
      file:
        path: "/etc/rancher/k3s"
        state: directory
        mode: '0755'

    - name: Fetch kubeconfig from master to worker
      slurp:
        src: "/home/{{ provision_user }}/.kube/config"
      delegate_to: "{{ k3s_master }}"
      register: kubeconfig_content

    - name: Write kubeconfig to worker
      copy:
        content: "{{ kubeconfig_content.content | b64decode }}"
        dest: "/etc/rancher/k3s/k3s.yaml"
        owner: root
        group: root
        mode: '0644'

    - name: Set global KUBECONFIG in /etc/environment
      lineinfile:
        path: /etc/environment
        line: 'KUBECONFIG=/etc/rancher/k3s/k3s.yaml'
        regexp: '^KUBECONFIG='
        state: present

    - name: Remove KUBECONFIG from .bashrc
      lineinfile:
        path: "/home/{{ provision_user }}/.bashrc"
        regexp: '^export KUBECONFIG='
        state: absent

    # ============================================================================
    # VERIFICATION
    # ============================================================================

    - name: Check K3s agent service status
      systemd:
        name: k3s-agent
      register: agent_status

    - name: Display agent status
      debug:
        msg: "K3s Agent on {{ inventory_hostname }} is {{ agent_status.status.ActiveState }}"

    - name: Show recent K3s agent logs
      shell: journalctl -u k3s-agent -n 10 --no-pager
      register: agent_logs

    - debug:
        msg: "{{ agent_logs.stdout }}"
