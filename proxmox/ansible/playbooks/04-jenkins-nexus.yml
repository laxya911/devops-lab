################################################################################
# ANSIBLE PLAYBOOK 04: DOCKER-BASED CI/CD STACK (JENKINS + NEXUS + K3S REGISTRY TRUST)
# FEATURES:
# - Jenkins + Nexus run fully in Docker containers
# - Persistent volumes (/opt/jenkins, /opt/nexus)
# - Jenkins pre-configured with kubeconfig to access K3s cluster
# - Nexus acts as Docker registry (port 5000)
# - All K3s nodes trust Nexus registry for pulling images
# - Firewall rules configured
# - Fully automated plug-and-play setup for nexus
################################################################################

---
- name: Setup Jenkins + Nexus server
  hosts: jenkins_servers
  become: true
  gather_facts: true

  vars:
    jenkins_port: 8080
    jenkins_home: /opt/jenkins
    jenkins_image: jenkins/jenkins:2.541.1-lts
    nexus_image: sonatype/nexus3:3.87.2
    nexus_port: 8081
    nexus_docker_port: 5000
    nexus_data: /opt/nexus

    # New: tooling + kubeconfig for Jenkins pipelines
    jenkins_tools_dir: /srv/jenkins-tools
    kubeconfig_host_path: /home/ansible/.kube/config

    # Versions for kubectl + docker CLI (adjust to your k3s version)
    kubectl_version: v1.35.0
    docker_cli_version: 29.1.5
    docker_buildx_version: v0.31.0

  handlers:
    - name: Restart Docker
      systemd:
        name: docker
        state: restarted

  tasks:
    # --------------------------------------------------------------------------
    # Install Docker Engine
    # --------------------------------------------------------------------------
    - name: Install Docker prerequisites
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present
        update_cache: yes

    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present

    - name: Install Docker Engine
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
          - docker-buildx-plugin
        state: present

    - name: Ensure Docker is running
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Configure Docker insecure registry
      copy:
        dest: /etc/docker/daemon.json
        content: |
          {
            "insecure-registries": ["{{ ansible_host }}:5000", "jenkins-nexus:5000"]
          }
        mode: '0644'
      notify: Restart Docker

    - name: Add ansible user to docker group
      user:
        name: ansible
        groups: docker
        append: yes

    # --------------------------------------------------------------------------
    # Docker Network
    # --------------------------------------------------------------------------
    - name: Create Docker network for CI/CD
      docker_network:
        name: cicd-network
        state: present

    # --------------------------------------------------------------------------
    # Persistent directories
    # --------------------------------------------------------------------------
    - name: Create Jenkins home directory
      file:
        path: "{{ jenkins_home }}"
        state: directory
        owner: 1000
        group: 1000
        mode: '0755'

    - name: Create Nexus data directory
      file:
        path: "{{ nexus_data }}"
        state: directory
        owner: 200
        group: 200
        mode: '0755'

    # New: tooling dir for kubectl + docker inside Jenkins container
    - name: Create Jenkins tools directory
      file:
        path: "{{ jenkins_tools_dir }}"
        state: directory
        owner: 1000
        group: 1000
        mode: '0755'

    # --------------------------------------------------------------------------
    # kubectl + Docker CLI for Jenkins (host binaries mounted into container)
    # --------------------------------------------------------------------------
    - name: Download kubectl binary
      get_url:
        url: "https://dl.k8s.io/release/{{ kubectl_version }}/bin/linux/amd64/kubectl"
        dest: "{{ jenkins_tools_dir }}/kubectl"
        mode: '0755'

    - name: Download Docker CLI archive
      get_url:
        url: "https://download.docker.com/linux/static/stable/x86_64/docker-{{ docker_cli_version }}.tgz"
        dest: /tmp/docker-cli.tgz
        mode: '0644'

    - name: Extract Docker CLI
      unarchive:
        src: /tmp/docker-cli.tgz
        dest: "{{ jenkins_tools_dir }}/"
        remote_src: yes
        creates: "{{ jenkins_tools_dir }}/docker/docker"

    - name: Symlink docker binary into tools root
      file:
        src: "{{ jenkins_tools_dir }}/docker/docker"
        dest: "{{ jenkins_tools_dir }}/docker-cli"
        state: link

    - name: Create Jenkins Docker plugins directory
      file:
        path: "{{ jenkins_tools_dir }}/cli-plugins"
        state: directory
        owner: 1000
        group: 1000
        mode: '0755'

    - name: Download Docker Buildx binary
      get_url:
        url: "https://github.com/docker/buildx/releases/download/{{ docker_buildx_version }}/buildx-{{ docker_buildx_version }}.linux-amd64"
        dest: "{{ jenkins_tools_dir }}/cli-plugins/docker-buildx"
        mode: '0755'
        owner: 1000
        group: 1000


    # --------------------------------------------------------------------------
    # Fetch kubeconfig from K8s master and configure for Jenkins
    # --------------------------------------------------------------------------
    - name: Ensure kubeconfig directory exists
      file:
        path: "{{ kubeconfig_host_path | dirname }}"
        state: directory
        owner: ansible
        group: ansible
        mode: '0755'
      when: kubeconfig_host_path is defined

    - name: Debug kubeconfig variables
      debug:
        msg: "kubeconfig_host_path: {{ kubeconfig_host_path | default('UNDEFINED') }}"

    - name: Fetch kubeconfig from k8s master
      slurp:
        src: /etc/rancher/k3s/k3s.yaml
      register: kubeconfig_content
      delegate_to: "{{ groups['kubernetes_master'][0] }}"
      when: kubeconfig_host_path is defined
      ignore_errors: yes

    - name: Debug fetched content
      debug:
        msg: "Fetched content length: {{ (kubeconfig_content.content | b64decode | length) if kubeconfig_content.content is defined else 'N/A' }}"

    - name: Write kubeconfig to Jenkins server
      copy:
        content: "{{ kubeconfig_content.content | b64decode }}"
        dest: "{{ kubeconfig_host_path }}"
        owner: ansible
        group: ansible
        mode: '0644'
        force: yes
      when: 
        - kubeconfig_host_path is defined
        - kubeconfig_content.content is defined

    - name: Verify kubeconfig was copied successfully
      stat:
        path: "{{ kubeconfig_host_path }}"
      register: kubeconfig_stat
      when: kubeconfig_host_path is defined

    - name: Display kubeconfig status
      debug:
        msg: "Kubeconfig copied successfully: {{ kubeconfig_stat.stat.exists }}"
      when: kubeconfig_host_path is defined

    # --------------------------------------------------------------------------
    # Jenkins
    # --------------------------------------------------------------------------
    
    - name: Check if Jenkins is already initialized
      stat:
        path: "{{ jenkins_home }}/config.xml"
      register: jenkins_initialized
    
    - name: Ensure k3s directory exists on CI host
      file:
        path: "/etc/rancher/k3s"
        state: directory
        mode: '0755'

    - name: Write kubeconfig to CI host
      copy:
        content: "{{ kubeconfig_content.content | b64decode }}"
        dest: "/etc/rancher/k3s/k3s.yaml"
        owner: root
        group: root
        mode: '0644'
      when: kubeconfig_host_path is defined

    - name: Set global KUBECONFIG in /etc/environment
      lineinfile:
        path: /etc/environment
        line: 'KUBECONFIG=/etc/rancher/k3s/k3s.yaml'
        regexp: '^KUBECONFIG='
        state: present

    - name: Get Docker group GID
      shell: "getent group docker | cut -d: -f3"
      register: docker_gid
      changed_when: false

    - name: Start Jenkins container
      docker_container:
        name: jenkins
        image: "{{ jenkins_image }}"
        network_mode: cicd-network
        state: started
        restart_policy: always
        ports:
          - "8080:8080"
        groups:
          - "{{ docker_gid.stdout }}"
        volumes:
          - "{{ jenkins_home }}:/var/jenkins_home"
          - /var/run/docker.sock:/var/run/docker.sock
          - "{{ jenkins_tools_dir }}/kubectl:/usr/local/bin/kubectl:ro"
          - "{{ jenkins_tools_dir }}/docker/docker:/usr/local/bin/docker:ro"
          - "{{ jenkins_tools_dir }}/cli-plugins:/usr/lib/docker/cli-plugins:ro"
          - "/etc/rancher/k3s:/home/ansible/.kube:ro"
        env:
          CASC_JENKINS_CONFIG: /var/jenkins_home/casc
          TZ: "Asia/Kolkata"
          KUBECONFIG: "/home/ansible/.kube/k3s.yaml"

    - name: Check if Jenkins initial admin password exists
      stat:
        path: "{{ jenkins_home }}/secrets/initialAdminPassword"
      register: jenkins_pw_file

    - name: Read Jenkins initial admin password
      command: cat {{ jenkins_home }}/secrets/initialAdminPassword
      register: jenkins_admin_password
      when: jenkins_pw_file.stat.exists

    - name: Display Jenkins initial admin password
      debug:
        msg: "Jenkins initial admin password: {{ jenkins_admin_password.stdout }}"
      when: jenkins_pw_file.stat.exists

    - name: Wait for Jenkins to be available
      wait_for:
        host: "{{ ansible_host }}"
        port: "{{ jenkins_port }}"
        timeout: 300
    # --------------------------------------------------------------------------
    # Nexus
    # --------------------------------------------------------------------------
    
    - name: Start Nexus container
      docker_container:
        name: nexus
        image: "{{ nexus_image }}"
        state: started
        restart_policy: always
        network_mode: cicd-network
        ports:
          - "{{ nexus_port }}:8081"
          - "{{ nexus_docker_port }}:5000"
        volumes:
          - "{{ nexus_data }}:/nexus-data"

    - name: Wait for Nexus API to be ready
      uri:
        url: "http://{{ ansible_host }}:{{ nexus_port }}/service/rest/v1/status"
        status_code: 200
      register: nexus_status
      retries: 30
      delay: 10
      until: nexus_status.status == 200

    - name: Check if Nexus initial admin password exists
      command: docker exec nexus test -f /nexus-data/admin.password
      register: nexus_pw_file
      failed_when: false
      changed_when: false

    - name: Read Nexus initial admin password
      command: docker exec nexus cat /nexus-data/admin.password
      register: nexus_admin_password
      when: nexus_pw_file.rc == 0

    - name: Display initial admin password
      debug:
        msg: "Initial admin password: {{ nexus_admin_password.stdout }}"
      when:
        - nexus_admin_password is defined
        - nexus_admin_password.stdout is defined

    - name: Change Nexus admin password
      uri:
        url: "http://{{ ansible_host }}:{{ nexus_port }}/service/rest/v1/security/users/admin/change-password"
        method: PUT
        user: admin
        password: "{{ nexus_admin_password.stdout }}"
        force_basic_auth: yes
        headers:
          Content-Type: text/plain
        body: nexus
        status_code: 204
      when:
        - nexus_admin_password is defined
        - nexus_admin_password.stdout is defined


    - name: Enable anonymous access
      uri:
        url: "http://{{ ansible_host }}:{{ nexus_port }}/service/rest/v1/security/anonymous"
        method: PUT
        user: admin
        password: nexus
        force_basic_auth: yes
        body:
          enabled: true
          userId: anonymous
          realmName: NexusAuthorizingRealm
        body_format: json
        status_code: 200

    - name: Enable Docker Bearer Token Realm
      uri:
        url: "http://{{ ansible_host }}:{{ nexus_port }}/service/rest/v1/security/realms/active"
        method: PUT
        user: admin
        password: nexus
        force_basic_auth: yes
        body:
          - NexusAuthenticatingRealm
          - DockerToken
        body_format: json
        status_code: 204

    - name: Get existing repositories
      uri:
        url: "http://{{ ansible_host }}:{{ nexus_port }}/service/rest/v1/repositories"
        method: GET
        user: admin
        password: nexus
        force_basic_auth: yes
      register: existing_repos

    - set_fact:
        repo_names: "{{ existing_repos.json | map(attribute='name') | list }}"
    
    
    - name: Create Docker hosted repository
      uri:
        url: "http://{{ ansible_host }}:{{ nexus_port }}/service/rest/v1/repositories/docker/hosted"
        method: POST
        user: admin
        password: nexus
        force_basic_auth: yes
        body:
          name: docker-hosted
          online: true
          storage:
            blobStoreName: default
            strictContentTypeValidation: true
            writePolicy: ALLOW
          docker:
            v1Enabled: false
            forceBasicAuth: true
            httpPort: "{{ nexus_docker_port }}"
        body_format: json
        status_code: 201
      when: "'docker-hosted' not in repo_names"

    

################################################################################
# Configure K3s nodes to trust Nexus registry
################################################################################

- name: Configure K3s nodes to trust Nexus Docker registry
  hosts: kubernetes_master:kubernetes_workers
  become: true
  gather_facts: true

  vars:
    registry_host: "{{ hostvars[groups['jenkins_servers'][0]].ansible_host }}"
    registry_port: 5000
    registry_yaml_path: /etc/rancher/k3s/registries.yaml

  tasks:
    - name: Ensure K3s registry directory exists
      file:
        path: /etc/rancher/k3s
        state: directory
        mode: '0755'

    - name: Ensure registries.yaml exists
      copy:
        dest: "{{ registry_yaml_path }}"
        content: ""
        owner: root
        group: root
        mode: '0644'

    - name: Configure Nexus registry mirror
      blockinfile:
        path: "{{ registry_yaml_path }}"
        marker: "# {mark} ANSIBLE NEXUS REGISTRY"
        block: |
          mirrors:
            "{{ registry_host }}:{{ registry_port }}":
              endpoint:
                - "http://{{ registry_host }}:{{ registry_port }}"
          configs:
            "{{ registry_host }}:{{ registry_port }}":
              tls:
                insecure_skip_verify: true

    - name: Restart K3s server on master
      systemd:
        name: k3s
        state: restarted
      when: "'kubernetes_master' in group_names"

    - name: Restart K3s agent on workers
      systemd:
        name: k3s-agent
        state: restarted
      when: "'kubernetes_workers' in group_names"
